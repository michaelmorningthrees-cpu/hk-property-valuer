name: Valuation Scraper Worker

on:
  schedule:
    # è¨­å®šæ¯ 30 åˆ†é˜é‹è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•æŒ‰æŒ‰éˆ•æ¸¬è©¦

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # è¨­å®šè¶…æ™‚ï¼Œé˜²æ­¢å¡æ­»

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        # å®‰è£ package.json è£¡é¢æ‰€æœ‰å˜¢
        run: npm ci

      - name: Install Playwright Browsers
        # åªå®‰è£ Chromium ä»¥ç¯€çœæ™‚é–“
        run: npx playwright install chromium --with-deps

      # ğŸ‘‡ 1. æ–°å¢é€™ä¸€æ­¥ï¼šå®‰è£è™›æ“¬è¢å¹• XVFB (è§£æ±º Missing X server å•é¡Œ)
      - name: Install XVFB
        run: sudo apt-get install -y xvfb

      - name: Run Scraper Script
        env:
          # è®€å– GitHub Secrets
          GOOGLE_SCRIPT_URL: ${{ secrets.GOOGLE_SCRIPT_URL }}
          GS_SECRET_TOKEN: ${{ secrets.GS_SECRET_TOKEN }}
          CI: true 
        # ğŸ‘‡ 2. ä¿®æ”¹é€™ä¸€æ­¥ï¼šä½¿ç”¨ xvfb-run ä¾†åŸ·è¡Œ nodeï¼Œæ¨¡æ“¬æœ‰ä¸€å€‹ 1280x960 çš„è¢å¹•
        run: xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" node scraper.js